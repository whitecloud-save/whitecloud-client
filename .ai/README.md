# AI 助手工作指南

本文文件定义了 AI 助手在 whitecloud-client 项目中的工作原则和约束。

## 核心原则（最高优先级）

### 🚫 禁止自动提交代码
**这是 AI 助手必须严格遵守的核心规范**：

- ❌ **禁止**在没有用户明确指令的情况下执行 `git commit` 操作
- ❌ **禁止**完成任务后自动提交代码
- ❌ **禁止**根据上下文"合理推断"需要提交而自动提交
- ✅ 只有在用户明确说"提交"、"commit"或类似明确指令时才执行提交

**正确流程**：
```
用户："帮我修复这个 bug"
    ↓
AI 修复 bug，报告完成情况
    ↓
❌ AI 禁止执行 git commit
    ↓
用户："提交代码"（明确指令）
    ↓
AI 执行 git commit
```

**错误示例**：
```
用户："创建一个 angular skill"
    ↓
AI 创建 skill
    ↓
❌ AI 禁止自动 git commit（即使这是常规操作）
```

**适用范围**：所有场景，包括但不限于：
- 创建新功能
- 修复 bug
- 重构代码
- 添加配置
- 创建 skill/command
- 任何代码修改

**例外**：无例外。用户必须每次都明确给出提交指令。

## AI 工作原则

### 1. 语言偏好
**默认使用中文输出**
- 所有回复、注释、文档内容必须使用中文
- 代码注释使用中文编写
- 提交信息使用中文
- 只有在用户明确要求使用英文时才使用英文

### 2. 问题解决策略
**先查文档，再询问用户，禁止猜测**

遇到问题时，按以下顺序操作：
1. **查阅文档**
   - 搜索项目中的 README、文档目录
   - 检查代码注释和类型定义
   - 查看 TypeScript 类型声明

2. **搜索代码库**
   - 使用 grep 搜索相关实现
   - 查看类似功能的实现方式
   - 分析现有代码模式和约定

3. **询问用户**
   - 如果文档缺失或不清楚
   - 如果有多个可行的实现方案
   - 如果需要业务逻辑澄清

4. **禁止事项**
   - 绝对禁止猜测业务逻辑
   - 禁止在没有明确依据的情况下做技术决策
   - 禁止假设用户意图而不确认

### 3. OpenSpec 提案流程
**复杂功能必须先创建 OpenSpec 提案**

在以下情况必须使用 OpenSpec 创建变更提案：
- 添加新功能或特性
- 进行重大变更（UI、架构）
- 改变架构模式或设计
- 性能优化（涉及行为变更）
- 安全模式更新

提案创建步骤：
1. 同步 API 定义文件
   - 在创建提案前，必须先同步 `api.ts` 文件
   - 调用 `/sync-api` 命令执行同步
   - 确保服务器接口定义保持最新
   - 基于最新的 API 定义进行提案规划
2. 查看 `openspec/project.md` 了解项目上下文
3. 运行 `openspec-cn list` 和 `openspec-cn list --specs` 了解当前状态
4. 创建变更目录和文件（proposal.md、tasks.md、design.md、spec 增量）
5. 使用 `openspec-cn validate <id> --strict --no-interactive` 验证
6. 在获得批准后开始实施

跳过提案的情况：
- 错误修复（恢复预期行为）
- 拼写错误、格式化、注释
- 依赖项更新（非重大变更）
- 配置更改
- 现有行为的测试

### 4. 代码修改流程
**修改前必读文档，修改后必更文档**

在进行任何代码修改前，必须遵循以下流程：

#### 修改前
1. **同步 API 定义文件**
   - 在执行提案规划或代码修改前，必须先同步 `api.ts` 文件
   - 调用 `/sync-api` 命令执行同步
   - 确保服务器接口定义保持最新
   - 避免基于过时的 API 定义进行开发

2. **阅读项目总览**
   - 必须阅读 `.ai/doc/project.md` 文档
   - 确保理解项目的整体架构、技术栈、业务模块设计
   - 确认修改内容与现有设计不冲突

3. **理解现有设计**
    - 分析相关模块的实现方式
    - 理解 Angular 组件和服务的约定
    - 确认修改方案符合项目架构

4. **加载相关经验**
    - 根据 `.ai/exp/index.md` 索引文件
    - 提取任务关键词（文件名、方法名、操作类型）
    - 匹配适用场景和核心概念
    - 仅加载匹配度高的经验文档
    - 遵循经验中的"正确实现"和"经验总结"

5. **规划修改内容**
    - 在充分理解项目设计后，才开始规划修改内容
    - 遵循 Angular 最佳实践

6. **明确工作流程**
   - 对于涉及本地数据库的变更，明确工作流程：
     - 修改实体定义 → 运行构建 → 测试验证（数据库自动同步）
   - 对于涉及服务端 API 的变更，明确工作流程：
     - 修改代码 → 运行构建 → 测试验证

#### 修改后
1. **更新文档**
   - 代码修改完成后，必须及时更新 `.ai/doc/project.md` 文档
   - 更新内容包括但不限于：
     - 新增的业务模块
     - 修改的模块功能
     - 新增或修改的 API 接口
     - 本地数据库结构变更
     - 组件结构变更
   - 确保文档与代码保持同步

2. **文档更新检查清单**
   - [ ] 更新相关业务模块说明
   - [ ] 更新本地数据模型说明
   - [ ] 更新目录结构（如有新增文件）
   - [ ] 更新依赖项（如有新增依赖）

**重要提醒**：
- ❌ 禁止在未阅读 `.ai/doc/project.md` 的情况下进行代码修改
- ❌ 禁止代码修改后不更新 `.ai/doc/project.md` 文档
- ✅ 文档更新与代码修改同等重要
- ✅ 文档过时可能导致后续开发出现不一致

## 禁止事项

### 1. Git 命令限制
**禁止使用 `git reset` 命令**

原因：
- git reset 可能导致数据丢失
- 可能有不可逆的影响
- 不符合安全的版本控制实践

替代方案：
- 使用 `git revert` 撤销已提交的变更
- 使用 `git checkout` 查看旧版本
- 与用户沟通后采取安全的操作

### 2. 数据库操作限制
**禁止通过命令行直接操作数据库**

原因：
- 本地数据库使用 SQLite，文件路径为 `data/db.sqlite`
- 直接操作可能导致数据丢失或损坏
- 难以追踪和回滚
- 不符合代码审查流程

替代方案：
- 项目使用 TypeORM 的 synchronize 模式自动同步数据库结构
- 修改实体定义后，重启应用会自动更新数据库结构
- 编写数据库操作代码并通过测试
- 如需迁移数据，编写迁移脚本

### 3. Git 操作约定
**禁止自动执行 git commit 操作**

#### Git Commit 操作规则
- ❌ **禁止** AI 主动自动执行 `git commit` 操作
- ✅ 只有在用户明确要求时才执行 `git commit`
- ✅ AI 可以根据上下文判断是否需要提交，并询问用户确认
- ✅ 得到用户确认后，可以执行 `git commit` 操作

**重要提醒**：
- ❌ 即使完成所有任务，也**禁止**自动执行 git commit
- ❌ 即使 git commit 失败后，也**禁止**自动重新执行
- ❌ **绝对禁止**在没有用户明确指令的情况下执行任何 git commit 操作
- ✅ 必须每次执行前都询问用户确认
- ✅ 用户明确要求时才能执行 git commit 操作

#### 禁止自动提交的核心原则
**这是 AI 助手的核心工作规范，必须严格遵守**：
1. **没有用户明确指令 = 禁止提交**
   - 用户说"提交代码" → ✅ 可以提交
   - 用户说"创建一个 skill" → ❌ 完成后禁止自动提交
   - 用户说"修复这个 bug" → ❌ 修复后禁止自动提交
   - 用户说"添加新功能" → ❌ 完成后禁止自动提交

2. **完成任务 ≠ 可以提交**
   - 完成任何任务后，都**禁止**自动提交
   - 只报告任务完成情况，不执行 git commit
   - 如需提交，等待用户明确指令

3. **判断需要的场景**
   - AI 可以建议："任务已完成，是否需要提交代码？"
   - AI 可以提示："检测到未提交的变更，建议提交。"
   - 但**禁止**在获得确认前执行 git commit

#### 操作流程
```
AI 检测到需要提交的场景（例如：完成某项任务后）
    ↓
AI 询问："检测到已完成的工作，是否需要提交？"
    ↓
用户确认：是
    ↓
AI 执行 git commit 操作
```

### 4. 其他禁止事项
- 禁止在生产环境执行未经测试的命令
- 禁止修改系统配置文件（如 /etc）而不询问用户
- 禁止删除重要文件或数据
- 禁止运行可能导致系统不稳定或数据丢失的操作
- 禁止创建或使用违反禁止事项的 Skills
- 禁止在简单任务中强制加载经验文档
- 禁止仅凭经验文档的"错误实现"来判断，必须结合当前任务实际

### 5. 命令执行错误处理规范

**禁止自动解决命令错误**

#### 错误处理规则
- ❌ **禁止** 命令执行失败时自动尝试修复代码或命令
- ❌ **禁止** 在未获得用户确认前重复执行失败的操作
- ✅ 必须总结错误信息并向用户报告问题
- ✅ 必须等待用户确认后再执行任何修复操作

#### 错误处理流程
```
命令执行失败（如 npm run build、ng build 等）
    ↓
AI 分析并总结错误信息
    ↓
AI 向用户报告问题：
  1. 错误类型（如编译错误、lint 错误等）
  2. 错误位置（文件名、行号）
  3. 可能的原因分析
  4. 建议的解决方案（可选）
    ↓
AI 等待用户确认处理方案
    ↓
用户确认后，AI 执行修复操作
```

## 项目特定约定

### 项目架构
**Electron + Angular 桌面应用**

- **主进程**：Electron 主进程（`src/electron.ts`）
- **渲染进程**：Angular 应用（`src/app/`）
- **通信**：IPC 通信（主进程与渲染进程之间）
- **本地数据库**：SQLite + TypeORM
- **服务端通信**：WebSocket + HTTP

### Skills 机制
**Skills 是扩展 AI 助手能力的机制，存储在 `.opencode/skills/` 目录下**

#### Skills 结构
```
.opencode/skills/
└── <skill-name>/
    ├── SKILL.md              # 主指令文件（必需）
    ├── reference.md          # 参考文档（可选）
    ├── examples.md           # 示例（可选）
    └── templates/           # 模板文件（可选）
```

#### 已实现的 Skills
- **commit-message**: Git 提交信息生成（基于 Conventional Commits 标准）
- **angular**: Angular 框架编程助手（组件、路由、表单、HTTP、依赖注入等）
- **ng-zorro**: NG-ZORRO Ant Design UI 组件库开发助手（70+ 企业级 UI 组件）

#### 已实现的 Commands
- **commit**: Git 提交命令
- **openspec-proposal**: 创建 OpenSpec 变更提案
- **openspec-apply**: 应用已批准的 OpenSpec 变更提案
- **openspec-archive**: 归档已完成的 OpenSpec 变更提案

#### Skills 使用方式
- 手动调用：`/skill-name [arguments]`
- 自动调用：根据描述自动加载相关 skill（如果未禁用）
- Skills 必须遵循本指南中的所有约束和原则

#### Skill 与 Command 的关系
- **Skill**：详细的技能规范，包含完整的步骤、约束、示例
  - 存储位置：`.opencode/skills/<skill-name>/`
  - 适用场景：所有技能都需要
  - 内容：详细的执行流程、错误处理、示例代码

- **Command**：简化的命令定义，供 AI 快速执行
  - 存储位置：`.opencode/command/<command-name>.md`
  - 适用场景：需要频繁手动调用的技能
  - 内容：简化的步骤，引用 skill 的详细规范

判断是否需要创建 Command：
- ✅ 需要用户频繁手动调用的技能（如 commit）
- ❌ 主要由 AI 自动调用的技能
- ❓ 不确定时倾向于创建（宁滥勿缺）

**创建新 Skill 的完整流程**：
1. 创建 `.opencode/skills/<skill-name>/` 目录
2. 编写 `SKILL.md` 文件
3. 添加辅助文件（reference.md、examples.md、templates/，可选）
4. 更新 `.opencode/skills/README.md` 中的"已实现 Skills"列表
5. 更新 `.ai/README.md` 中的"已实现 Skills"列表
6. 评估是否需要创建 command 文件
   - 如需要，创建 `.opencode/command/<command-name>.md`
   - 更新 `.opencode/command/README.md` 中的命令列表

### 代码风格
- **语言**：TypeScript
- **框架**：Angular 17
- **UI 组件库**：ng-zorro-antd (Ant Design for Angular)
- **数据库 ORM**：TypeORM
- **本地数据库**：SQLite
- **格式化**：ESLint（在提交时自动运行）
- **命名**：
  - 组件：PascalCase，后缀为 `Component`（如 `GameListComponent`）
  - 服务：PascalCase，后缀为 `Service`（如 `GameService`）
  - 管道：PascalCase，后缀为 `Pipe`（如 `FileSizePipe`）
  - 模块：PascalCase，后缀为 `Module`（如 `GameModule`）
  - 变量：camelCase
  - 常量：UPPER_CASE
- **导入**：使用相对路径导入 Angular 和项目模块

### 技术栈
- **框架**：Angular 17
- **桌面框架**：Electron 30
- **UI 组件库**：ng-zorro-antd 17
- **数据库**：SQLite + TypeORM
- **HTTP 客户端**：Axios
- **其他库**：
  - @whitecloud-save/binding-addon：游戏存档绑定
  - jszip：ZIP 文件处理
  - qrcode：二维码生成
  - uuid：UUID 生成
  - mkdirp：目录创建

## 责任声明
本指南旨在确保 AI 助手在项目中的行为一致、安全、可预测。如需修改本指南，请与项目负责人确认。
