# 存档管理规范

## 目的

本规范定义了游戏存档管理系统的核心功能，包括存档备份、存档对比、存档大小限制等功能，确保存档数据的安全性和一致性。

## 需求

### 需求：存档目录哈希计算
系统必须提供计算目录哈希的功能，用于判断存档内容是否变化。

#### 场景：计算目录哈希
- **当** 调用 Utility.calculateDirectoryHash(directoryPath)
- **那么** 必须递归读取目录下所有文件
- **并且** 按文件路径排序确保一致性
- **并且** 将文件路径和内容一起计算 SHA1 哈希
- **并且** 返回哈希字符串（16 进制格式，前 10 位）

#### 场景：计算目录大小
- **当** 调用 Utility.calculateDirectorySize(directoryPath)
- **那么** 必须递归计算目录下所有文件的总大小
- **并且** 返回总大小（字节数）

#### 场景：计算文件哈希
- **当** 调用 Utility.calculateFileHash(filePath)
- **那么** 必须使用 SHA1 算法计算文件哈希
- **并且** 返回哈希字符串（16 进制格式，前 10 位）

### 需求：存档对比缓存机制
系统必须使用缓存机制提供存档对比功能，避免重复计算。

#### 场景：Game 初始化时计算缓存
- **当** Game.init() 方法执行
- **并且** 存档列表加载完成
- **那么** 必须计算与当前存档一致的最新备份
- **并且** 将结果缓存到 `currentSave_` 私有变量
- **并且** 如果没有匹配，缓存 null

#### 场景：获取与当前一致的最新存档（返回缓存）
- **当** 调用 Game.getCurrentSave()
- **那么** 必须返回缓存的 `currentSave_` 值
- **并且** 不进行任何哈希计算

#### 场景：创建新存档后更新缓存
- **当** Game.zipSave() 备份存档完成
- **那么** 必须调用 updateCurrentSave() 更新缓存
- **并且** 重新计算与当前存档一致的最新备份
- **并且** 将结果更新到 `currentSave_` 私有变量

#### 场景：存档回滚后更新缓存
- **当** Save.rollback() 执行完成
- **那么** 必须通知 Game 对象更新缓存
- **并且** Game 调用 updateCurrentSave() 重新计算
- **并且** 将结果更新到 `currentSave_` 私有变量

#### 场景：远端游戏同步后更新缓存
- **当** GameService.importRemoteGame() 将远端游戏同步到本地
- **那么** 必须调用 Game.updateCurrentSave() 更新缓存
- **并且** 重新计算与当前存档一致的最新备份
- **并且** 将结果更新到 `currentSave_` 私有变量

### 需求：存档对比内部实现
系统必须提供存档对比的内部实现方法，用于缓存更新。

#### 场景：重新计算当前存档匹配
- **当** 调用 Game.updateCurrentSave()
- **并且** 当前存档目录有效
- **那么** 必须计算当前存档目录的大小和哈希
- **并且** 先筛选 directorySize 相同的存档
- **并且** 再在筛选结果中匹配 directoryHash
- **并且** 如果有多个匹配，返回创建时间最晚的
- **并且** 更新 `currentSave_` 私有变量

#### 场景：无匹配存档
- **当** 调用 Game.updateCurrentSave()
- **并且** 没有存档与当前存档匹配
- **那么** 将 `currentSave_` 设置为 null

#### 场景：目录大小不同立即返回
- **当** 调用 Game.updateCurrentSave()
- **并且** 当前存档大小与所有已备份存档不同
- **那么** 将 `currentSave_` 设置为 null，不计算哈希

### 需求：存档备份时计算哈希
系统必须在存档备份时计算并存储哈希值。

#### 场景：备份存档时计算哈希
- **当** Game.zipSave() 备份存档
- **那么** 必须在 ZIP 文件创建前计算 directoryHash 和 directorySize
- **并且** 在 ZIP 文件创建后计算 zipHash
- **并且** 将三个哈希值存储到 SaveDB
- **并且** 更新 SaveDB 记录到数据库
- **并且** 调用 updateCurrentSave() 更新缓存

#### 场景：兼容旧存档
- **当** 加载没有哈希字段的旧存档
- **那么** directoryHash、zipHash、directorySize 应为 null
- **并且** 不影响存档的正常使用

### 需求：存档数据模型
SaveDB 实体必须扩展以支持存档对比功能。

#### 场景：创建存档记录时存储哈希
- **当** 创建新的 SaveDB 记录
- **并且** 备份存档时
- **那么** directoryHash 字段必须存储目录哈希
- **并且** zipHash 字段必须存储 ZIP 文件哈希
- **并且** directorySize 字段必须存储未压缩大小
- **并且** 三个字段可为 null（兼容旧数据）

### 需求：Game 初始化流程
Game 类必须在初始化时计算存档对比缓存并检测存档大小。

#### 场景：Game 初始化完成后计算缓存
- **当** Game.init() 方法执行
- **并且** 存档列表加载完成（init() 中的存档加载逻辑）
- **那么** 必须调用 updateCurrentSave() 计算与当前存档一致的最新备份
- **并且** 将结果缓存到 `currentSave_` 私有变量

#### 场景：Game 初始化时检测存档大小
- **当** Game.init() 方法执行
- **并且** 存档路径可访问
- **那么** 必须计算存档文件夹大小
- **并且** 获取有效备份上限（游戏自定义或全局设置）
- **并且** 如果存档大小超过上限，设置状态为 SaveSizeExceeded
- **否则** 继续正常的 checkState() 状态检测

#### 场景：存档路径不可访问
- **当** Game.init() 方法执行
- **并且** 存档路径不可访问
- **那么** 不进行存档大小检测
- **并且** 继续正常的 checkState() 状态检测

### 需求：全局存档备份上限设置
系统必须提供全局的存档备份大小上限设置。

#### 场景：设置全局备份上限
- **当** 用户在基础设置页面设置"本地存档备份上限"
- **那么** 必须将设置值存储到 localStorage
- **并且** 设置范围限制在 10MB 到 100MB 之间
- **并且** 默认值为 100MB

#### 场景：加载全局备份上限
- **当** 应用启动时调用 SettingService.load()
- **那么** 必须从 localStorage 加载全局备份上限设置
- **并且** 如果未设置，使用默认值 100MB

### 需求：游戏级别存档备份上限设置
系统必须支持为单个游戏设置独立的存档备份上限。

#### 场景：启用游戏自定义备份上限
- **当** 用户在游戏存档设置页面开启"使用自定义备份上限"
- **那么** 必须在 LocalGameDB 中设置 useCustomSaveBackupLimit 为 true
- **并且** 启用备份上限滑块控件

#### 场景：禁用游戏自定义备份上限
- **当** 用户在游戏存档设置页面关闭"使用自定义备份上限"
- **那么** 必须在 LocalGameDB 中设置 useCustomSaveBackupLimit 为 false
- **并且** 该游戏使用全局备份上限设置

#### 场景：设置游戏备份上限值
- **当** 用户在游戏存档设置页面调整"备份上限"滑块
- **那么** 必须将值存储到 LocalGameDB.saveBackupLimit
- **并且** 设置范围限制在 10MB 到 100MB 之间

### 需求：存档大小超限状态
系统必须在游戏初始化时检测存档文件夹大小，并在超限时进入特殊状态。

#### 场景：获取有效备份上限
- **当** Game 需要确定存档备份上限时
- **如果** 游戏的 useCustomSaveBackupLimit 为 true
- **那么** 使用游戏的 saveBackupLimit 值
- **否则** 使用全局 globalSaveBackupLimit 值

#### 场景：存档大小超过上限
- **当** Game.init() 检测存档文件夹
- **并且** 存档文件夹大小超过有效备份上限
- **那么** 必须将游戏状态设置为 SaveSizeExceeded (5)

#### 场景：存档大小未超过上限
- **当** Game.init() 检测存档文件夹
- **并且** 存档文件夹大小未超过有效备份上限
- **那么** 继续正常的初始化状态检测流程

#### 场景：超限状态不自动备份
- **当** 游戏状态为 SaveSizeExceeded
- **并且** 游戏进程退出
- **那么** 不得执行自动存档备份（zipSave）

#### 场景：备份时检测到超限
- **当** 执行存档备份（zipSave）
- **并且** 计算存档文件夹大小时发现超过有效备份上限
- **那么** 必须将游戏状态设置为 SaveSizeExceeded
- **并且** 中止本次备份操作

### 需求：存档超限 UI 提示
系统必须在游戏导航栏下方显示存档超限提示。

#### 场景：显示超限提示条
- **当** 游戏状态为 SaveSizeExceeded
- **那么** 必须在游戏导航栏下方显示黄底提示条
- **并且** 提示文案为"本游戏存档文件夹容量过大，当前禁用自动备份存档功能"
- **并且** 显示"去设置"按钮

#### 场景：点击去设置按钮（使用游戏自定义设置）
- **当** 用户点击"去设置"按钮
- **并且** 游戏已启用自定义备份上限
- **那么** 跳转到该游戏的设置页面

#### 场景：点击去设置按钮（使用全局设置）
- **当** 用户点击"去设置"按钮
- **并且** 游戏未启用自定义备份上限
- **那么** 跳转到全局基础设置页面

### 需求：手动备份确认
系统必须在存档超限时对手动备份操作进行确认。

#### 场景：超限状态手动备份确认
- **当** 游戏状态为 SaveSizeExceeded
- **并且** 用户点击"备份当前存档"按钮
- **那么** 必须弹出确认对话框
- **并且** 显示文案"本游戏存档文件夹容量过大，备份可能消耗较长时间与硬盘空间，是否确认继续"
- **并且** 提供"继续"和"取消"两个选项

#### 场景：确认继续备份
- **当** 用户在确认对话框中点击"继续"
- **那么** 执行存档备份操作

#### 场景：取消备份
- **当** 用户在确认对话框中点击"取消"
- **那么** 取消本次备份操作，不执行任何备份

#### 场景：非超限状态直接备份
- **当** 游戏状态不为 SaveSizeExceeded
- **并且** 用户点击"备份当前存档"按钮
- **那么** 直接执行存档备份操作，不弹出确认对话框
